# Как исправить проблему с временем уведомлений

## Что было исправлено

✅ **Исправлена нормализация формата времени** - теперь все времена правильно преобразуются в формат HH:MM:SS  
✅ **Добавлена поддержка часовых поясов** - уведомления теперь приходят в правильное время для вашего часового пояса  
✅ **Добавлена диагностическая страница** - теперь можно проверить настройки времени

## Что нужно сделать

### 1. Установите свой часовой пояс

1. Перейдите в **Настройки** (Settings)
2. Найдите раздел **"Часовой пояс"**
3. Выберите свой город или ближайший город в вашем часовом поясе
4. Нажмите **"Сохранить настройки"**

### 2. Проверьте времена уведомлений

#### Для конкретного именинника:
1. Откройте список именинников
2. Нажмите "Редактировать" на нужном именнике
3. Проверьте поле **"Время уведомления"**
4. Можно добавить до 5 разных времен (кнопка "+")
5. Сохраните изменения

#### В общих настройках:
1. Перейдите в **Настройки**
2. Найдите раздел **"Уведомления"**
3. Установите глобальное время уведомлений
4. Это время будет использоваться для всех именинников, у которых не установлено индивидуальное время

### 3. Проверьте настройки на диагностической странице

1. Откройте **Диагностическую страницу**: `/diagnostic`
2. Проверьте раздел **"Диагностика времени уведомлений"**
3. Убедитесь, что:
   - ✅ Часовой пояс установлен правильно
   - ✅ Времена уведомлений отображаются корректно
   - ✅ Текущее время в вашем часовом поясе правильное

### 4. Протестируйте уведомления

1. Установите время уведомления на **текущее время + 2 минуты**
2. Дождитесь указанного времени
3. Должно прийти push-уведомление

Если уведомление не пришло, проверьте:
- ✅ Уведомления включены в настройках браузера
- ✅ FCM токен зарегистрирован (на диагностической странице)
- ✅ Firebase Admin SDK настроен (проверьте переменные окружения)

## Частые проблемы

### Уведомления не приходят вообще

1. **Проверьте разрешения браузера**
   - Откройте настройки сайта в браузере
   - Убедитесь, что уведомления разрешены

2. **Проверьте FCM токен**
   - Откройте `/diagnostic`
   - Проверьте статус "FCM токен"
   - Если токен не зарегистрирован, откройте главную страницу приложения

3. **Проверьте Firebase Admin SDK**
   - Убедитесь, что переменные окружения `FIREBASE_SERVICE_ACCOUNT_KEY` установлены
   - См. `FIREBASE_ADMIN_SETUP.md`

### Уведомления приходят в неправильное время

1. **Проверьте часовой пояс**
   - Откройте Настройки → Часовой пояс
   - Выберите правильный часовой пояс
   - Сохраните изменения

2. **Проверьте формат времени**
   - Откройте `/diagnostic`
   - Проверьте, что времена отображаются в формате HH:MM:SS (например, 09:00:00)
   - Если формат другой, пересохраните времена уведомлений

### Как работает проверка времени

1. **Cron запускается каждую минуту** (через Vercel Cron или внешний сервис)
2. **Для каждого пользователя**:
   - Загружается его часовой пояс
   - Вычисляется текущее время в его часовом поясе
   - Проверяется, есть ли дни рождения сегодня
3. **Для каждого дня рождения сегодня**:
   - Собираются все времена уведомлений (индивидуальные + глобальные)
   - Проверяется, совпадает ли текущее время с одним из времен уведомлений
   - Если да - отправляется push-уведомление через Firebase Cloud Messaging

## Примеры настройки

### Пример 1: Уведомления в 9:00 утра по Москве

1. Часовой пояс: `Europe/Moscow` (UTC+3)
2. Время уведомления: `09:00`
3. Cron проверит в 06:00 UTC (= 09:00 MSK)

### Пример 2: Несколько уведомлений

1. Часовой пояс: `Europe/Warsaw` (UTC+1)
2. Времена: `09:00`, `12:00`, `18:00`
3. Уведомления придут в 09:00, 12:00 и 18:00 по варшавскому времени

### Пример 3: Глобальные + индивидуальные

1. Глобальное время: `09:00`
2. Для VIP-именника: `09:00`, `15:00`, `20:00`
3. VIP-именник получит 3 уведомления, остальные - 1

## Техническая информация

### Формат времени
- **В UI**: `HH:MM` (09:00)
- **В базе данных**: `HH:MM` или `HH:MM:SS`
- **В cron**: автоматическая нормализация к `HH:MM:SS`

### Часовые пояса
- Поддерживаются стандартные IANA timezone (например, `Europe/Moscow`, `America/New_York`)
- Если не установлен: используется UTC
- Специальные значения:
  - `auto` → UTC (автоопределение работает только в UI)
  - `disabled` → UTC

### Логи
Проверьте логи Vercel Functions для отладки:
```
[v0] Cron: Birthday TODAY: John Doe {
  userTimezone: 'Europe/Warsaw',
  userCurrentTime: '09:00:00',
  notificationTimes: ['09:00:00', '12:00:00'],
  shouldNotify: true
}
[v0] Cron: TIME MATCH! Sending notification
```

## Полезные ссылки

- [Диагностическая страница](/diagnostic)
- [Настройки](/settings)
- [Документация по Firebase](FIREBASE_SETUP.md)
- [Документация по Cron](EXTERNAL_CRON_SETUP.md)
