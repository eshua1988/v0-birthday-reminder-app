# 🔔 Firebase Push-уведомления - Полное руководство

## ✅ Текущий статус

**Firebase Cloud Messaging уже настроен и работает!**

Ваше приложение использует Firebase FCM для отправки push-уведомлений на:
- 💻 Desktop (Windows, macOS, Linux)
- 📱 Mobile (iOS 16.4+, Android)
- 🖥️ Tablet (iPad, Android tablets)

---

## 📱 Поддерживаемые платформы

### ✅ Desktop
| Браузер | Windows | macOS | Linux |
|---------|---------|-------|-------|
| Chrome | ✅ | ✅ | ✅ |
| Edge | ✅ | ✅ | ✅ |
| Firefox | ✅ | ✅ | ✅ |
| Safari | ❌ | ✅ | - |
| Opera | ✅ | ✅ | ✅ |

### ✅ Mobile
| Платформа | Браузер | Поддержка |
|-----------|---------|-----------|
| Android | Chrome | ✅ Полная |
| Android | Firefox | ✅ Полная |
| Android | Edge | ✅ Полная |
| Android | Samsung Internet | ✅ Полная |
| iOS | Safari | ✅ iOS 16.4+ |
| iOS | Chrome | ⚠️ Использует Safari движок |

### ✅ Tablet
| Платформа | Поддержка |
|-----------|-----------|
| iPad (iOS 16.4+) | ✅ Полная |
| Android Tablet | ✅ Полная |
| Windows Tablet | ✅ Полная |

---

## 🎯 Как работает Firebase FCM

```
┌─────────────────────────────────────────┐
│  1. Пользователь открывает приложение   │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  2. Запрашивается разрешение на         │
│     уведомления                         │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  3. Firebase генерирует FCM токен       │
│     (уникальный для каждого устройства) │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  4. Токен сохраняется в БД Supabase     │
│     (таблица fcm_tokens)                │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  5. Vercel Cron запускается каждый день │
│     в 9:00 утра                         │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  6. Проверяются дни рождения на сегодня │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  7. Firebase Admin SDK отправляет       │
│     уведомления на все FCM токены       │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  8. Уведомление доставляется через      │
│     Google Cloud Messaging              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  9. Пользователь получает уведомление   │
│     на всех своих устройствах           │
└─────────────────────────────────────────┘
```

---

## 🔧 Проверка настройки

### 1. Проверьте переменные окружения в Vercel

Убедитесь что настроены:

#### Firebase Client (для браузера):
```env
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyC...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project-id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123:web:abc
NEXT_PUBLIC_FIREBASE_VAPID_KEY=BN5x...
```

#### Firebase Admin (для сервера):
```env
FIREBASE_SERVICE_ACCOUNT_KEY={"type":"service_account",...}
CRON_SECRET=your-random-secret-key
```

### 2. Проверьте Firebase Console

1. Откройте [Firebase Console](https://console.firebase.google.com/)
2. Выберите ваш проект
3. **Cloud Messaging** → убедитесь что API включен
4. **Web Push certificates** → проверьте VAPID key

### 3. Проверьте Service Worker

Откройте приложение и проверьте в DevTools (F12):
- **Application** → **Service Workers**
- Должен быть активен: `firebase-messaging-sw.js`
- Статус: **activated and is running**

---

## 🧪 Тестирование на разных устройствах

### Desktop (Chrome/Edge/Firefox)

1. Откройте приложение
2. Разрешите уведомления
3. Откройте **Настройки**
4. Нажмите **"Отправить тестовое уведомление"**
5. ✅ Должно появиться уведомление в системном трее

### Mobile Android (Chrome)

1. Откройте приложение в Chrome
2. При запросе разрешите уведомления
3. **Настройки** → **"Отправить тестовое уведомление"**
4. ✅ Уведомление появится даже если приложение закрыто

### Mobile iOS (Safari 16.4+)

1. Откройте приложение в Safari
2. Нажмите **AA** в адресной строке
3. **Настройки веб-сайта** → Включите **Уведомления**
4. **Настройки** → **"Отправить тестовое уведомление"**
5. ✅ Уведомление появится

### Tablet (iPad/Android)

Те же шаги что и для мобильных устройств.

---

## 🎨 Особенности для разных платформ

### Desktop
- ✅ Уведомления в системном трее
- ✅ Звук уведомления
- ✅ Работает когда браузер закрыт (если разрешено)
- ✅ Клик открывает/фокусирует приложение

### Android
- ✅ Нативный вид уведомлений
- ✅ Вибрация (паттерн: 200ms-100ms-200ms)
- ✅ Работает в фоне
- ✅ Иконка и badge приложения
- ✅ Действия: "Открыть" / "Закрыть"

### iOS (16.4+)
- ✅ Нативный вид iOS
- ✅ Требуется добавление на главный экран
- ✅ Работает в фоне после установки
- ⚠️ Требуется iOS 16.4 или новее

---

## 🐛 Troubleshooting

### "No FCM tokens found"

**Причина:** Пользователь не разрешил уведомления

**Решение:**
1. Проверьте разрешения браузера
2. Chrome: `chrome://settings/content/notifications`
3. Удалите блокировку для вашего сайта
4. Перезагрузите страницу

### "Permission denied"

**Причина:** Пользователь заблокировал уведомления

**Решение:**
1. Очистите разрешения сайта в браузере
2. Перезагрузите страницу
3. При запросе выберите "Разрешить"

### "Service Worker not registered"

**Причина:** Ошибка регистрации SW

**Решение:**
1. Проверьте `/firebase-messaging-sw.js` доступен
2. Проверьте консоль на ошибки
3. Очистите кэш браузера

### iOS: "Notifications not supported"

**Причина:** iOS < 16.4 или не установлено на главный экран

**Решение:**
1. Обновите iOS до 16.4+
2. Добавьте приложение на главный экран через Safari
3. Откройте приложение с главного экрана

---

## 📊 Мониторинг

### Проверка логов в Vercel

1. Откройте [Vercel Dashboard](https://vercel.com/dashboard)
2. Выберите проект
3. **Deployments** → последний деплой → **Runtime Logs**
4. Ищите строки с `[v0] Cron:`

### Проверка отправленных уведомлений

```bash
# Ручной запуск cron
curl https://v0-birthday-reminder-app-liart.vercel.app/api/test-cron
```

### Firebase Console Analytics

1. [Firebase Console](https://console.firebase.google.com/)
2. **Cloud Messaging** → **Reports**
3. Статистика доставки уведомлений

---

## 🚀 Оптимизация

### Для лучшей доставки

1. **Установите PWA** на устройство
   - Desktop: Chrome → `⋮` → Install app
   - Mobile: Safari → Share → Add to Home Screen

2. **Разрешите фоновые уведомления**
   - Desktop: Chrome Settings → Advanced → Continue running in background
   - Mobile: автоматически работает

3. **Не блокируйте сайт**
   - Не добавляйте в блокировщики
   - Не отключайте JavaScript

---

## ✅ Checklist настройки

- [ ] Firebase проект создан
- [ ] Cloud Messaging API включен
- [ ] Service Account key загружен в Vercel
- [ ] VAPID key настроен в Vercel
- [ ] Web Push certificates добавлены в Firebase
- [ ] CRON_SECRET настроен в Vercel
- [ ] Vercel Cron настроен (9:00 ежедневно)
- [ ] Тестовое уведомление работает
- [ ] Service Worker активен
- [ ] FCM токены сохраняются в БД

---

## 📞 Поддержка

**Firebase работает и настроен правильно!**

Если уведомления не приходят:
1. Проверьте разрешения браузера
2. Отправьте тестовое уведомление
3. Проверьте логи в Vercel
4. Проверьте FCM токены в БД Supabase
